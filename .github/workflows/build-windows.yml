name: Build Windows Executable

on:
  push:
    branches: [ windows-executable ]
  pull_request:
    branches: [ windows-executable ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'  # 使用 3.8 以支援 Windows 7
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
      continue-on-error: false
      
    - name: Install python-pptx
      run: pip install python-pptx
      
    - name: Install python-docx
      run: pip install python-docx
    
    - name: Build executables
      run: |
        cd word_to_ppt
        pyinstaller --onefile --name 1_extract --console --add-data "template.pptx;." --add-data "config.txt;." 1_extract.py
        pyinstaller --onefile --name 2_generate --console --add-data "template.pptx;." --add-data "config.txt;." 2_generate.py
    
    - name: Prepare release package
      run: |
        mkdir release
        copy word_to_ppt\dist\1_extract.exe release\
        copy word_to_ppt\dist\2_generate.exe release\
        copy word_to_ppt\template.pptx release\
        copy word_to_ppt\config.txt release\
        copy word_to_ppt\input.docx release\
        echo Word 轉 PPT 工具 - 使用說明 > release\使用說明.txt
        echo "" >> release\使用說明.txt
        echo ================================ >> release\使用說明.txt
        echo "" >> release\使用說明.txt
        echo 使用步驟： >> release\使用說明.txt
        echo "" >> release\使用說明.txt
        echo 1. 將您的 Word 檔案命名為 input.docx 放入此資料夾 >> release\使用說明.txt
        echo "" >> release\使用說明.txt
        echo 2. 雙擊 1_extract.exe 提取藍色文字 >> release\使用說明.txt
        echo    程式會自動生成 output.txt >> release\使用說明.txt
        echo "" >> release\使用說明.txt
        echo 3. 用記事本編輯 output.txt，填入變數： >> release\使用說明.txt
        echo    - 日期 >> release\使用說明.txt
        echo    - 禮拜類型 >> release\使用說明.txt
        echo    - 主題 >> release\使用說明.txt
        echo    - 經文章節 >> release\使用說明.txt
        echo    - 經文內容 >> release\使用說明.txt
        echo "" >> release\使用說明.txt
        echo 4. 雙擊 2_generate.exe 生成 PPT >> release\使用說明.txt
        echo    程式會自動生成 output.pptx >> release\使用說明.txt
        echo "" >> release\使用說明.txt
        echo 5. 開啟 output.pptx 查看結果 >> release\使用說明.txt
        echo "" >> release\使用說明.txt
        echo ================================ >> release\使用說明.txt
        echo "" >> release\使用說明.txt
        echo 設定檔說明： >> release\使用說明.txt
        echo "" >> release\使用說明.txt
        echo config.txt 可以設定： >> release\使用說明.txt
        echo - 提取文字的顏色 >> release\使用說明.txt
        echo - PPT 的頁面結構 >> release\使用說明.txt
        echo "" >> release\使用說明.txt
        echo 如遇到問題，請查看 error.log 檔案 >> release\使用說明.txt
        echo "" >> release\使用說明.txt
        Compress-Archive -Path release\* -DestinationPath word-to-ppt-windows.zip
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: word-to-ppt-windows
        path: word-to-ppt-windows.zip
    
    - name: Create Release
      if: github.event_name == 'push'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: Word to PPT Windows v${{ github.run_number }}
        body: |
          ## Word 轉 PPT Windows 版本
          
          ### 使用方式
          1. 下載並解壓縮 `word-to-ppt-windows.zip`
          2. 將您的 Word 檔案命名為 `input.docx` 放入資料夾
          3. 雙擊 `1_extract.exe` 提取文字
          4. 用記事本編輯 `output.txt` 填入變數
          5. 雙擊 `2_generate.exe` 生成 PPT
          6. 開啟 `output.pptx` 查看結果
          
          ### 包含檔案
          - `1_extract.exe` - 提取文字工具
          - `2_generate.exe` - 生成 PPT 工具
          - `template.pptx` - 模板檔案
          - `config.txt` - 設定檔
          - `input.docx` - 範例輸入檔案
          - `使用說明.txt` - 使用說明
        files: |
          word-to-ppt-windows.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
